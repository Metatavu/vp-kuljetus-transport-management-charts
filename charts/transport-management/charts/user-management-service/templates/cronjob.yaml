{{- $serviceHostname := printf "%s-user-management-service.%s.svc.cluster.local:8080" .Release.Name .Release.Namespace }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-user-management-service-cronjob
spec:
  schedule: "* * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: endunresolvedworkshifts
            envFrom:
              - secretRef:
                  name: {{ .Values.userManagementServiceSecretName }}
            command:
            - /bin/sh
            - -c
            - |
              if ! curl --silent --show-error --fail --header "X-CRON-Key: $VP_USERMANAGEMENT_CRON_APIKEY" http://{{ $serviceHostname }}/v1/cron/endUnresolvedWorkshifts; then
                echo 'Failed to end unresolved workshifts' >&2
                exit 1
              fi
            image: curlimages/curl:8.16.0
            imagePullPolicy: Always
            resources: {}
            terminationMessagePath: /dev/termination-log
            terminationMessagePolicy: File
          - name: removeeventduplicates
            envFrom:
              - secretRef:
                  name: {{ .Values.userManagementServiceSecretName }}
            command:
            - /bin/sh
            - -c
            - |
              if ! curl --silent --show-error --fail --max-time 120 --connect-timeout 120 --header "X-CRON-Key: $VP_USERMANAGEMENT_CRON_APIKEY" http://{{ $serviceHostname }}/v1/cron/removeEventDuplicates; then
                echo 'Failed to remove event duplicates' >&2
                exit 1
              fi
            image: curlimages/curl:8.16.0
            imagePullPolicy: Always
            resources: {}
            terminationMessagePath: /dev/termination-log
            terminationMessagePolicy: File
          dnsPolicy: ClusterFirst
          restartPolicy: OnFailure
          schedulerName: default-scheduler
          securityContext: {}
          terminationGracePeriodSeconds: 30
